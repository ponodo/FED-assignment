<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HawkerHub - Menu Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  </head>
  <body class="bg-light">
    <nav class="navbar bg-white shadow-sm py-3">
      <div class="container">
        <a class="navbar-brand text-danger fw-bold" href="index.html">
          <i class="bi bi-shop-window me-2"></i>HawkerHub
        </a>
        <a href="vendor-dashboard.html" class="btn btn-outline-danger btn-sm">
          <i class="bi bi-arrow-left me-1"></i>Dashboard
        </a>
      </div>
    </nav>

    <main class="container py-4">
      <h1 class="text-danger mb-4">Menu Management</h1>

      <!-- Add New Item -->
      <div class="card mb-4">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0">Add Menu Item</h5>
        </div>
        <div class="card-body">
          <form id="addItemForm">
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Item Name *"
                  id="itemName"
                  required
                />
              </div>
              <div class="col-md-6">
                <select class="form-select" id="itemCategory" required>
                  <option value="">Category</option>
                  <option>Main Course</option>
                  <option>Side Dish</option>
                  <option>Beverage</option>
                  <option>Dessert</option>
                </select>
              </div>
            </div>
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <input
                  type="number"
                  class="form-control"
                  placeholder="Price ($) *"
                  id="itemPrice"
                  step="0.50"
                  required
                />
              </div>
              <div class="col-md-6">
                <select class="form-select" id="itemAvailability" required>
                  <option value="available">Available</option>
                  <option value="unavailable">Unavailable</option>
                  <option value="soldout">Sold Out</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <textarea
                class="form-control"
                placeholder="Description"
                id="itemDescription"
                rows="2"
              ></textarea>
            </div>
            <button type="submit" class="btn btn-danger w-100" id="submitBtn">
              Add Item
            </button>
          </form>
        </div>
      </div>

      <!-- Menu Items -->
      <div class="card">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0">Menu Items</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Item Name</th>
                  <th>Category</th>
                  <th>Price</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="menuItemsTable">
                <tr id="loadingRow">
                  <td colspan="5" class="text-center py-4">
                    <div class="spinner-border text-danger" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading menu items...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <footer class="bg-dark text-white py-3 mt-4">
      <div class="container text-center">
        <p class="mb-0 small">&copy; 2024 HawkerHub</p>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBK3Miw6Kissl4wd3RdVw6PXBhuFAL_QGQ",
        authDomain: "hawkerhub-513e8.firebaseapp.com",
        databaseURL:
          "https://hawkerhub-513e8-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "hawkerhub-513e8",
        storageBucket: "hawkerhub-513e8.firebasestorage.app",
        messagingSenderId: "396562198613",
        appId: "1:396562198613:web:593c1922573a27211624dc",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      // Database paths
      const MENU_ITEMS_PATH = "menuItems";

      // Check if user is logged in
      const user = JSON.parse(localStorage.getItem("hawkerhub_user"));
      if (!user || user.role !== "vendor") {
        window.location.href = "login.html";
      }

      // Get vendor's stall ID
      const vendorStallId = user.stallId || 2;
      const vendorStallName = user.stallName || "My Stall";

      // Variables
      let editingItemId = null;

      // Load menu items when page loads
      document.addEventListener("DOMContentLoaded", function () {
        loadMenuItemsFromFirebase();
      });

      // Load items from Firebase
      function loadMenuItemsFromFirebase() {
        const menuItemsRef = database.ref(MENU_ITEMS_PATH);

        menuItemsRef
          .orderByChild("stallId")
          .equalTo(vendorStallId)
          .on(
            "value",
            (snapshot) => {
              const loadingRow = document.getElementById("loadingRow");
              if (loadingRow) loadingRow.remove();

              const table = document.getElementById("menuItemsTable");
              table.innerHTML = "";

              if (!snapshot.exists()) {
                table.innerHTML = `
              <tr>
                <td colspan="5" class="text-center py-5">
                  <i class="bi bi-egg-fried fs-1 text-muted"></i>
                  <h5 class="mt-3">No menu items yet</h5>
                  <p class="text-muted">Add your first menu item using the form above!</p>
                </td>
              </tr>
            `;
                return;
              }

              const items = [];
              snapshot.forEach((childSnapshot) => {
                const item = childSnapshot.val();
                item.id = childSnapshot.key;
                items.push(item);
              });

              displayItemsInTable(items);
            },
            (error) => {
              console.error("Firebase Error:", error);
              document.getElementById("loadingRow").innerHTML = `
            <td colspan="5" class="text-center py-4 text-danger">
              <i class="bi bi-exclamation-triangle fs-4"></i>
              <p class="mt-2">Error loading menu items</p>
              <button class="btn btn-sm btn-outline-danger mt-2" onclick="loadMenuItemsFromFirebase()">
                Retry
              </button>
            </td>
          `;
            },
          );
      }

      // Display items in the table
      function displayItemsInTable(items) {
        const table = document.getElementById("menuItemsTable");

        // Sort by name
        items.sort((a, b) => a.name.localeCompare(b.name));

        items.forEach((item) => {
          let badgeClass = "bg-secondary";
          switch (item.availability) {
            case "available":
              badgeClass = "bg-success";
              break;
            case "unavailable":
              badgeClass = "bg-danger";
              break;
            case "soldout":
              badgeClass = "bg-warning text-dark";
              break;
          }

          const row = table.insertRow();
          row.setAttribute("data-item-id", item.id);

          row.innerHTML = `
            <td class="align-middle">
              <strong>${item.name}</strong>
              ${item.description ? `<br><small class="text-muted">${item.description}</small>` : ""}
            </td>
            <td class="align-middle">
              <span class="badge bg-light text-dark border">${item.category}</span>
            </td>
            <td class="align-middle">
              <strong>$${parseFloat(item.price).toFixed(2)}</strong>
            </td>
            <td class="align-middle">
              <span class="badge ${badgeClass}">${item.availability}</span>
            </td>
            <td class="align-middle">
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-danger" onclick="editItem('${item.id}')">
                  <i class="bi bi-pencil"></i> Edit
                </button>
                <button class="btn btn-danger" onclick="deleteItem('${item.id}')">
                  <i class="bi bi-trash"></i> Delete
                </button>
              </div>
            </td>
          `;
        });
      }

      // Add new item
      document
        .getElementById("addItemForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const submitBtn = document.getElementById("submitBtn");
          const originalText = submitBtn.innerHTML;

          submitBtn.disabled = true;
          submitBtn.innerHTML =
            '<span class="spinner-border spinner-border-sm"></span> Saving...';

          try {
            const itemData = {
              name: document.getElementById("itemName").value.trim(),
              category: document.getElementById("itemCategory").value,
              price: parseFloat(document.getElementById("itemPrice").value),
              availability: document.getElementById("itemAvailability").value,
              description: document
                .getElementById("itemDescription")
                .value.trim(),
              stallId: vendorStallId,
              stallName: vendorStallName,
              updatedAt: firebase.database.ServerValue.TIMESTAMP,
            };

            if (editingItemId) {
              // Update existing item
              await database
                .ref(`${MENU_ITEMS_PATH}/${editingItemId}`)
                .update(itemData);
              alert("Item updated successfully!");
              editingItemId = null;
              submitBtn.textContent = "Add Item";
            } else {
              // Add new item
              itemData.createdAt = firebase.database.ServerValue.TIMESTAMP;
              await database.ref(MENU_ITEMS_PATH).push(itemData);
              alert("Item added successfully!");
            }

            // Reset form
            document.getElementById("addItemForm").reset();
          } catch (error) {
            alert("Error: " + error.message);
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        });

      // Edit item
      async function editItem(itemId) {
        try {
          const snapshot = await database
            .ref(`${MENU_ITEMS_PATH}/${itemId}`)
            .once("value");
          const item = snapshot.val();

          if (!item) {
            alert("Item not found!");
            return;
          }

          document.getElementById("itemName").value = item.name;
          document.getElementById("itemCategory").value = item.category;
          document.getElementById("itemPrice").value = item.price;
          document.getElementById("itemAvailability").value = item.availability;
          document.getElementById("itemDescription").value =
            item.description || "";

          editingItemId = itemId;
          document.getElementById("submitBtn").textContent = "Update Item";

          document
            .getElementById("addItemForm")
            .scrollIntoView({ behavior: "smooth" });
        } catch (error) {
          alert("Error loading item: " + error.message);
        }
      }

      // Delete item
      async function deleteItem(itemId) {
        if (!confirm("Are you sure you want to delete this item?")) return;

        try {
          await database.ref(`${MENU_ITEMS_PATH}/${itemId}`).remove();
          alert("Item deleted successfully!");
        } catch (error) {
          alert("Error deleting item: " + error.message);
        }
      }
    </script>
  </body>
</html>
