<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HawkerHub - Menu Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
  </head>
  <body class="bg-light">
    <nav class="navbar bg-white shadow-sm py-3">
      <div class="container">
        <a class="navbar-brand text-danger fw-bold" href="index.html">
          <i class="bi bi-shop-window me-2"></i>HawkerHub
        </a>
        <a href="vendor-dashboard.html" class="btn btn-outline-danger btn-sm">
          <i class="bi bi-arrow-left me-1"></i>Dashboard
        </a>
      </div>
    </nav>

    <main class="container py-4">
      <h1 class="text-danger mb-4">Menu Management</h1>

      <!-- Add New Item -->
      <div class="card mb-4">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0">Add Menu Item</h5>
        </div>
        <div class="card-body">
          <form id="addItemForm">
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Item Name *"
                  id="itemName"
                  required
                />
              </div>
              <div class="col-md-6">
                <select class="form-select" id="itemCategory" required>
                  <option value="">Category</option>
                  <option>Main Course</option>
                  <option>Side Dish</option>
                  <option>Beverage</option>
                  <option>Dessert</option>
                </select>
              </div>
            </div>
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <input
                  type="number"
                  class="form-control"
                  placeholder="Price ($) *"
                  id="itemPrice"
                  step="0.50"
                  required
                />
              </div>
              <div class="col-md-6">
                <select class="form-select" id="itemAvailability" required>
                  <option value="available">Available</option>
                  <option value="unavailable">Unavailable</option>
                  <option value="soldout">Sold Out</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <textarea
                class="form-control"
                placeholder="Description"
                id="itemDescription"
                rows="2"
              ></textarea>
            </div>
            <button type="submit" class="btn btn-danger w-100">Add Item</button>
          </form>
        </div>
      </div>

      <!-- Menu Items -->
      <div class="card">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0">Menu Items</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Item Name</th>
                  <th>Category</th>
                  <th>Price</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="menuItemsTable">
                <!-- Items will load here from JSON -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <footer class="bg-dark text-white py-3 mt-4">
      <div class="container text-center">
        <p class="mb-0 small">&copy; 2024 HawkerHub</p>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Check vendor
      const user = JSON.parse(localStorage.getItem("hawkerhub_user"));
      if (!user || user.role !== "vendor") {
        window.location.href = "login.html";
      }

      // Get vendor's stall ID (assuming it's stored in user data)
      // For testing, you can set this in your login page or here
      const vendorStallId = 2; // Default to stallId 2 (Tian Tian Chicken Rice)

      // Storage for items vendor adds
      const STORAGE_KEY = "hawkerhub_added_items";

      // Load menu items on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadMenuItems();
      });

      // Load items from JSON file
      async function loadMenuItems() {
        try {
          // Load from your JSON file
          const response = await fetch("data/menu.json");
          const jsonItems = await response.json();

          // Filter items for this vendor's stall
          const jsonItemsForVendor = jsonItems.filter(
            (item) => item.stallId === vendorStallId,
          );

          // Load items vendor added (saved in localStorage)
          const addedItems = JSON.parse(
            localStorage.getItem(STORAGE_KEY) || "[]",
          );

          // Combine JSON items and added items
          const allItems = [...jsonItemsForVendor, ...addedItems];

          // Display all items in table
          displayItemsInTable(allItems);
        } catch (error) {
          console.error("Error loading menu items:", error);
          alert("Could not load menu items. Please check your JSON file.");
        }
      }

      // Display items in the table
      function displayItemsInTable(items) {
        const table = document.getElementById("menuItemsTable");
        table.innerHTML = "";

        items.forEach((item) => {
          let badgeClass = "bg-secondary";
          if (item.availability === "available") badgeClass = "bg-success";
          else if (item.availability === "unavailable")
            badgeClass = "bg-danger";
          else if (item.availability === "soldout") badgeClass = "bg-warning";

          const row = table.insertRow();
          row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.category}</td>
            <td>$${item.price.toFixed(2)}</td>
            <td><span class="badge ${badgeClass}">${item.availability}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-danger me-1" onclick="editItem(this)">
                Edit
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteItem(this)">
                Delete
              </button>
            </td>
          `;
        });
      }

      // Add new item
      document
        .getElementById("addItemForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const newItem = {
            id: Date.now(), // Simple ID
            name: document.getElementById("itemName").value,
            category: document.getElementById("itemCategory").value,
            price: parseFloat(document.getElementById("itemPrice").value),
            availability: document.getElementById("itemAvailability").value,
            description: document.getElementById("itemDescription").value,
            stallId: vendorStallId,
            stallName: "My Stall", // You can customize this
          };

          // Get current added items
          const addedItems = JSON.parse(
            localStorage.getItem(STORAGE_KEY) || "[]",
          );
          addedItems.push(newItem);

          // Save to localStorage
          localStorage.setItem(STORAGE_KEY, JSON.stringify(addedItems));

          // Add to table
          addRowToTable(newItem);

          // Reset form
          document.getElementById("addItemForm").reset();
          alert("Item added!");
        });

      // Helper to add a single row
      function addRowToTable(item) {
        const table = document.getElementById("menuItemsTable");

        let badgeClass = "bg-secondary";
        if (item.availability === "available") badgeClass = "bg-success";
        else if (item.availability === "unavailable") badgeClass = "bg-danger";
        else if (item.availability === "soldout") badgeClass = "bg-warning";

        const row = table.insertRow();
        row.innerHTML = `
          <td>${item.name}</td>
          <td>${item.category}</td>
          <td>$${item.price.toFixed(2)}</td>
          <td><span class="badge ${badgeClass}">${item.availability}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-danger me-1" onclick="editItem(this)">
              Edit
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteItem(this)">
              Delete
            </button>
          </td>
        `;
      }

      // Edit item (simple version)
      function editItem(button) {
        const row = button.closest("tr");
        const cells = row.querySelectorAll("td");

        document.getElementById("itemName").value = cells[0].textContent;
        document.getElementById("itemCategory").value = cells[1].textContent;
        document.getElementById("itemPrice").value =
          cells[2].textContent.replace("$", "");

        const statusText = cells[3]
          .querySelector(".badge")
          .textContent.toLowerCase();
        document.getElementById("itemAvailability").value = statusText;

        const form = document.getElementById("addItemForm");
        const btn = form.querySelector('button[type="submit"]');
        btn.textContent = "Update Item";

        form.onsubmit = function (e) {
          e.preventDefault();

          // Update the table row
          cells[0].textContent = document.getElementById("itemName").value;
          cells[1].textContent = document.getElementById("itemCategory").value;
          cells[2].textContent =
            "$" + document.getElementById("itemPrice").value;

          const avail = document.getElementById("itemAvailability").value;
          let badgeClass = "bg-secondary";
          if (avail === "available") badgeClass = "bg-success";
          else if (avail === "unavailable") badgeClass = "bg-danger";
          else if (avail === "soldout") badgeClass = "bg-warning";

          cells[3].innerHTML = `<span class="badge ${badgeClass}">${avail}</span>`;

          // Save changes to localStorage
          saveEditedItemToStorage(row, {
            name: cells[0].textContent,
            category: cells[1].textContent,
            price: parseFloat(document.getElementById("itemPrice").value),
            availability: avail,
            description: document.getElementById("itemDescription").value,
          });

          // Reset form
          form.reset();
          btn.textContent = "Add Item";
          form.onsubmit = null;
          alert("Item updated!");
        };
      }

      // Save edited item to localStorage
      function saveEditedItemToStorage(row, updatedItem) {
        const addedItems = JSON.parse(
          localStorage.getItem(STORAGE_KEY) || "[]",
        );

        // Find and update the item (you'd need to track IDs better for a real app)
        // This is a simplified version
        const itemName = row.cells[0].textContent;
        const itemIndex = addedItems.findIndex(
          (item) => item.name === itemName,
        );

        if (itemIndex !== -1) {
          addedItems[itemIndex] = {
            ...addedItems[itemIndex],
            ...updatedItem,
          };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(addedItems));
        }
      }

      // Delete item
      function deleteItem(button) {
        if (confirm("Delete this item?")) {
          const row = button.closest("tr");
          const itemName = row.cells[0].textContent;

          // Remove from localStorage
          const addedItems = JSON.parse(
            localStorage.getItem(STORAGE_KEY) || "[]",
          );
          const filteredItems = addedItems.filter(
            (item) => item.name !== itemName,
          );
          localStorage.setItem(STORAGE_KEY, JSON.stringify(filteredItems));

          // Remove from table
          row.remove();
          alert("Item deleted!");
        }
      }
    </script>
  </body>
</html>
