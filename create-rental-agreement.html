<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Create Rental Agreement</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <div class="container mt-5">
      <h1 class="text-danger mb-4">Create Rental Agreement</h1>

      <form id="createAgreementForm">
        <div class="mb-3">
          <label class="form-label">Stall ID</label>
          <input id="stallId" class="form-control" placeholder="Enter Stall ID" required />
        </div>

        <div class="mb-3">
          <label class="form-label">Monthly Rent</label>
          <input type="number" id="monthlyRent" class="form-control" placeholder="Enter amount" required />
        </div>

        <div class="row mb-3">
          <div class="col">
            <label class="form-label">Start Date</label>
            <input type="date" id="startDate" class="form-control" required />
          </div>
          <div class="col">
            <label class="form-label">End Date</label>
            <input type="date" id="endDate" class="form-control" required />
          </div>
        </div>

        <button type="submit" class="btn btn-danger">Create Agreement</button>
        <a href="rental-agreements.html" class="btn btn-outline-secondary ms-2">Cancel</a>
      </form>
    </div>

    <!-- SINGLE MODULE SCRIPT -->
    <script type="module">
      // 1️⃣ Import Firebase and Firestore (matching versions)
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
      import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

      // 2️⃣ Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyBazksxHfRgOJcraIVqslvCWqZT4qjTWZE",
        authDomain: "hawkerhub-b4a7a.firebaseapp.com",
        projectId: "hawkerhub-b4a7a",
        storageBucket: "hawkerhub-b4a7a.appspot.com",
        messagingSenderId: "43569063246",
        appId: "1:43569063246:web:9d18d5107d2081784e2a1f"
      };

      // 3️⃣ Initialize Firebase & Firestore
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // 4️⃣ Handle form submission
      const form = document.getElementById("createAgreementForm");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Get vendor data from localStorage
        const user = JSON.parse(localStorage.getItem("hawkerhub_user"));
        if (!user || user.role !== "vendor") {
          alert("You must be logged in as a vendor.");
          window.location.href = "login.html";
          return;
        }

        const stallId = document.getElementById("stallId").value.trim();
        const monthlyRent = parseFloat(document.getElementById("monthlyRent").value);
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;

        // Validate inputs
        if (!stallId || isNaN(monthlyRent) || !startDate || !endDate) {
          alert("Please fill out all fields correctly.");
          return;
        }

        try {
          // Add document to Firestore
          const docRef = await addDoc(collection(db, "rentalAgreements"), {
            vendorId: user.vendorId,
            stallId,
            monthlyRent,
            startDate,
            endDate,
            status: "active",
            createdAt: new Date()
          });
          alert("Rental agreement created successfully! Document ID: " + docRef.id);
          window.location.href = "rental-agreements.html";
        } catch (err) {
          console.error("Firestore error:", err);
          alert("Failed to create rental agreement:\n" + err.message);
        }
      });
    </script>
  </body>
</html>