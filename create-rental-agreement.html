<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HawkerHub - Create Rental Agreement</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>

<body>
  <div class="container mt-5">
    <h1 class="text-danger mb-4">Create Rental Agreement</h1>

    <form id="createAgreementForm">

      <!-- Stall ID -->
      <div class="mb-3">
        <label class="form-label">Stall ID *</label>
        <input
          id="stallId"
          class="form-control"
          placeholder="Enter Stall ID"
          required
        />
      </div>

      <!-- Stall Name -->
      <div class="mb-3">
        <label class="form-label">Stall Name *</label>
        <input
          id="stallName"
          class="form-control"
          placeholder="e.g. Tian Tian Chicken Rice"
          required
        />
      </div>

      <!-- Hawker Centre -->
      <div class="mb-3">
        <label class="form-label">Hawker Centre *</label>
        <input
          id="hawkerCenter"
          class="form-control"
          placeholder="e.g. Maxwell Food Centre"
          required
        />
      </div>

      <!-- Stall Size -->
      <div class="mb-3">
        <label class="form-label">Stall Size (sq ft) *</label>
        <input
          type="number"
          id="stallSize"
          class="form-control"
          placeholder="e.g. 150"
          required
        />
      </div>

      <!-- Monthly Rent -->
      <div class="mb-3">
        <label class="form-label">Monthly Rent ($) *</label>
        <input
          type="number"
          id="monthlyRent"
          class="form-control"
          placeholder="Enter amount"
          required
        />
      </div>

      <!-- Agreement Dates -->
      <div class="row mb-3">
        <div class="col">
          <label class="form-label">Start Date *</label>
          <input type="date" id="startDate" class="form-control" required />
        </div>
        <div class="col">
          <label class="form-label">End Date *</label>
          <input type="date" id="endDate" class="form-control" required />
        </div>
      </div>

      <button type="submit" class="btn btn-danger">
        Create Agreement
      </button>
      <a href="rental-agreements.html" class="btn btn-outline-secondary ms-2">
        Cancel
      </a>

    </form>
  </div>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBazksxHfRgOJcraIVqslvCWqZT4qjTWZE",
      authDomain: "hawkerhub-b4a7a.firebaseapp.com",
      projectId: "hawkerhub-b4a7a",
      storageBucket: "hawkerhub-b4a7a.appspot.com",
      messagingSenderId: "43569063246",
      appId: "1:43569063246:web:9d18d5107d2081784e2a1f"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const form = document.getElementById("createAgreementForm");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const user = JSON.parse(localStorage.getItem("hawkerhub_user"));
      if (!user || user.role !== "vendor") {
        alert("You must be logged in as a vendor.");
        window.location.href = "login.html";
        return;
      }

      const stallId = document.getElementById("stallId").value.trim();
      const stallName = document.getElementById("stallName").value.trim();
      const hawkerCenter = document.getElementById("hawkerCenter").value.trim();
      const stallSize = parseInt(document.getElementById("stallSize").value);
      const monthlyRent = parseFloat(document.getElementById("monthlyRent").value);
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;

      if (
        !stallId || !stallName || !hawkerCenter ||
        isNaN(stallSize) || isNaN(monthlyRent) ||
        !startDate || !endDate
      ) {
        alert("Please fill in all fields correctly.");
        return;
      }

      try {
        // Create rental agreement
        const agreementRef = await addDoc(collection(db, "rentalAgreements"), {
          vendorId: user.vendorId,
          stallId,
          stallName,
          hawkerCenter,
          stallSize,
          monthlyRent,
          startDate,
          endDate,
          status: "active",
          createdAt: new Date()
        });

        // Auto-generate monthly payments
        const start = new Date(startDate);
        const end = new Date(endDate);

        while (start <= end) {
          const dueDate = `${start.getFullYear()}-${String(
            start.getMonth() + 1
          ).padStart(2, "0")}-05`;

          await addDoc(collection(db, "payments"), {
            vendorId: user.vendorId,
            agreementId: agreementRef.id,
            stallId,
            stallName,
            amount: monthlyRent,
            dueDate,
            status: "pending",
            paymentDate: null
          });

          start.setMonth(start.getMonth() + 1);
        }

        alert("Rental agreement created successfully!");
        window.location.href = "rental-agreements.html";

      } catch (err) {
        console.error(err);
        alert("Failed to create agreement.\n" + err.message);
      }
    });
  </script>
</body>
</html>