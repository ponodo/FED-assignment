<!doctype html>
<html lang="en">
  <head>
    <!-- Basic page setup -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HawkerHub - My Orders</title>

    <!-- Bootstrap CSS (layout + components) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />

    <!-- Your own CSS -->
    <link rel="stylesheet" href="css/style.css" />
  </head>

  <body>
    <!-- =========================
         NAVBAR
         ========================= -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
      <div class="container">
        <!-- Brand / Logo -->
        <a class="navbar-brand text-danger fw-bold" href="index.html">
          <i class="bi bi-shop-window me-2"></i>HawkerHub
        </a>

        <!-- Right-side navigation buttons -->
        <div class="d-flex align-items-center">
          <a href="order.html" class="btn btn-outline-danger me-3">
            <i class="bi bi-basket me-2"></i>Order Food
          </a>
          <a href="customer-dashboard.html" class="btn btn-outline-danger">
            <i class="bi bi-speedometer2 me-2"></i>Dashboard
          </a>
        </div>
      </div>
    </nav>

    <!-- =========================
         MAIN CONTENT
         ========================= -->
    <div class="container mt-5">
      <h1 class="mb-4 text-danger">My Orders</h1>

      <!-- =========================
           FILTER DROPDOWN
           =========================
           User selects status -> JS filters orders shown below
      -->
      <div class="row mb-4">
        <div class="col-md-3">
          <!-- Simplified id: statusFilter -> statusPick -->
          <select class="form-select" id="statusPick" onchange="filterOrders()">
            <option value="all">All Orders</option>
            <option value="pending">Pending</option>
            <option value="preparing">Preparing</option>
            <option value="ready">Ready</option>
            <option value="completed">Completed</option>
          </select>
        </div>
      </div>

      <!-- =========================
           ORDERS LIST CONTAINER
           =========================
           JS will insert order cards inside here.
      -->
      <!-- Simplified id: ordersList -> orderBox -->
      <div id="orderBox" class="order-box">
        <!-- Default empty message (JS will replace when orders exist) -->
        <div class="text-center py-5">
          <i class="bi bi-receipt display-1 text-muted mb-3"></i>
          <h4>No orders yet</h4>
          <p class="text-muted">Start ordering from our delicious hawker stalls!</p>
          <a href="order.html" class="btn btn-danger mt-3">Order Now</a>
        </div>
      </div>
    </div>

    <!-- =========================
         FOOTER
         ========================= -->
    <footer class="bg-dark text-white py-4 mt-5">
      <div class="container text-center">
        <p>&copy; 2024 HawkerHub. All rights reserved.</p>
      </div>
    </footer>

    <!-- Bootstrap JS bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      /* =========================================================
         HOW THIS PAGE WORKS (BIG PICTURE)
         =========================================================
         1) Orders are stored in localStorage under the key "orders"
         2) When page loads -> loadOrders() runs and displays them
         3) When user changes filter dropdown -> filterOrders() runs
         4) Clicking "View Details" -> viewOrder(orderId) shows an alert
      */

      /* =========================================================
         HELPER: Get the badge color depending on status
         ========================================================= */
      function getBadgeClass(status) {
        // Default color (if status doesn't match anything)
        let badgeClass = "bg-secondary";

        // Choose color by status
        if (status === "pending") badgeClass = "bg-warning";
        else if (status === "preparing") badgeClass = "bg-info";
        else if (status === "ready") badgeClass = "bg-primary";
        else if (status === "completed") badgeClass = "bg-success";

        return badgeClass;
      }

      /* =========================================================
         1) LOAD ALL ORDERS (no filter)
         ========================================================= */
      function loadOrders() {
        // Read orders from localStorage (if none, use empty array)
        const orders = JSON.parse(localStorage.getItem("orders")) || [];

        // Get the container where we will place the order cards
        const orderBox = document.getElementById("orderBox");

        // If no orders, show the empty message and stop
        if (orders.length === 0) {
          orderBox.innerHTML = `
            <div class="text-center py-5">
              <i class="bi bi-receipt display-1 text-muted mb-3"></i>
              <h4>No orders yet</h4>
              <p class="text-muted">Start ordering from our delicious hawker stalls!</p>
              <a href="order.html" class="btn btn-danger mt-3">Order Now</a>
            </div>
          `;
          return;
        }

        // Build the HTML for all orders
        let ordersHTML = "";

        orders.forEach((order) => {
          /* -------------------------
             Calculate totals
             -------------------------
             totalItems = sum of quantities
             totalAmount = subtotal (sum of price * quantity)
          */
          const totalItems = order.items.reduce(
            (sum, item) => sum + (item.quantity || 1),
            0
          );

          const totalAmount = order.items.reduce(
            (sum, item) => sum + item.price * (item.quantity || 1),
            0
          );

          // Delivery fee depends on deliveryType
          const deliveryFee = order.deliveryType === "delivery" ? 3.0 : 0;

          // Final total = subtotal + delivery fee
          const total = totalAmount + deliveryFee;

          // Badge color depends on status
          const badgeClass = getBadgeClass(order.status);

          /* -------------------------
             Create the order card HTML
             ------------------------- */
          ordersHTML += `
            <div class="card mb-3 order-card">
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-md-3">
                    <h6 class="mb-1">Order ${order.id}</h6>
                    <small class="text-muted">${order.date}</small>
                  </div>

                  <div class="col-md-3">
                    <p class="mb-1">${totalItems} items</p>
                    <small class="text-muted">${order.deliveryType}</small>
                  </div>

                  <div class="col-md-2">
                    <span class="fw-bold text-danger">$${total.toFixed(2)}</span>
                  </div>

                  <div class="col-md-2">
                    <span class="badge ${badgeClass}">${order.status}</span>
                  </div>

                  <div class="col-md-2 text-end">
                    <!-- Clicking this calls viewOrder(orderId) -->
                    <button class="btn btn-sm btn-outline-danger" onclick="viewOrder('${order.id}')">
                      View Details
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
        });

        // Put the final HTML into the page
        orderBox.innerHTML = ordersHTML;
      }

      /* =========================================================
         2) FILTER ORDERS BY STATUS
         ========================================================= */
      function filterOrders() {
        // Read selected filter value from dropdown
        const filter = document.getElementById("statusPick").value;

        // Read orders from localStorage
        const orders = JSON.parse(localStorage.getItem("orders")) || [];

        // Get container
        const orderBox = document.getElementById("orderBox");

        // If user chose "all", just show everything
        if (filter === "all") {
          loadOrders();
          return;
        }

        // Filter orders by status
        const filteredOrders = orders.filter((order) => order.status === filter);

        // If nothing matches this status, show "no results" message
        if (filteredOrders.length === 0) {
          orderBox.innerHTML = `
            <div class="text-center py-5">
              <i class="bi bi-search display-1 text-muted mb-3"></i>
              <h4>No ${filter} orders</h4>
              <p class="text-muted">You don't have any ${filter} orders.</p>
            </div>
          `;
          return;
        }

        // Build HTML for filtered orders
        let ordersHTML = "";

        filteredOrders.forEach((order) => {
          // Same totals logic as loadOrders()
          const totalItems = order.items.reduce(
            (sum, item) => sum + (item.quantity || 1),
            0
          );

          const totalAmount = order.items.reduce(
            (sum, item) => sum + item.price * (item.quantity || 1),
            0
          );

          const deliveryFee = order.deliveryType === "delivery" ? 3.0 : 0;
          const total = totalAmount + deliveryFee;

          // IMPORTANT: badge class should match status (not always yellow)
          const badgeClass = getBadgeClass(order.status);

          ordersHTML += `
            <div class="card mb-3 order-card">
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-md-3">
                    <h6 class="mb-1">Order ${order.id}</h6>
                    <small class="text-muted">${order.date}</small>
                  </div>

                  <div class="col-md-3">
                    <p class="mb-1">${totalItems} items</p>
                    <small class="text-muted">${order.deliveryType}</small>
                  </div>

                  <div class="col-md-2">
                    <span class="fw-bold text-danger">$${total.toFixed(2)}</span>
                  </div>

                  <div class="col-md-2">
                    <span class="badge ${badgeClass}">${order.status}</span>
                  </div>

                  <div class="col-md-2 text-end">
                    <button class="btn btn-sm btn-outline-danger" onclick="viewOrder('${order.id}')">
                      View Details
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
        });

        // Render the filtered cards
        orderBox.innerHTML = ordersHTML;
      }

      /* =========================================================
         3) VIEW ORDER DETAILS (ALERT POPUP)
         ========================================================= */
      function viewOrder(orderId) {
        // Read orders
        const orders = JSON.parse(localStorage.getItem("orders")) || [];

        // Find the order by id
        const order = orders.find((o) => o.id === orderId);

        // If order exists, build a readable details message
        if (order) {
          let details = `Order Details:\n\n`;
          details += `Order ID: ${order.id}\n`;
          details += `Date: ${order.date}\n`;
          details += `Customer: ${order.customer}\n`;
          details += `Phone: ${order.phone}\n`;
          details += `Delivery: ${order.deliveryType}\n`;
          details += `Address: ${order.address || "Pickup"}\n`;
          details += `Payment: ${order.paymentMethod}\n`;
          details += `Status: ${order.status}\n\n`;
          details += `Items:\n`;

          // List each item in the order
          order.items.forEach((item) => {
            const qty = item.quantity || 1;
            const lineTotal = item.price * qty;
            details += `- ${item.name} x${qty}: $${lineTotal.toFixed(2)}\n`;
          });

          // Calculate subtotal + delivery + total
          const subtotal = order.items.reduce(
            (sum, item) => sum + item.price * (item.quantity || 1),
            0
          );

          const deliveryFee = order.deliveryType === "delivery" ? 3.0 : 0;
          const total = subtotal + deliveryFee;

          details += `\nSubtotal: $${subtotal.toFixed(2)}\n`;
          details += `Delivery: $${deliveryFee.toFixed(2)}\n`;
          details += `Total: $${total.toFixed(2)}`;

          // Show in popup
          alert(details);
        }
      }

      /* =========================================================
         4) INITIALIZE (RUN ON PAGE LOAD)
         ========================================================= */
      window.addEventListener("load", () => {
        loadOrders();
      });
    </script>
  </body>
</html>
