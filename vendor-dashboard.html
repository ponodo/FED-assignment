<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HawkerHub - Vendor Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
  />
  <link rel="stylesheet" href="css/style.css" />
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand text-danger fw-bold" href="index.html">
        <i class="bi bi-shop-window me-2"></i>HawkerHub
      </a>

      <div class="dropdown">
        <button
          class="btn btn-outline-danger dropdown-toggle"
          data-bs-toggle="dropdown"
        >
          <i class="bi bi-person"></i> Vendor
        </button>
        <ul class="dropdown-menu">
          <li>
            <a class="dropdown-item" href="menu-management.html">
              Manage Menu
            </a>
          </li>
          <li>
            <a class="dropdown-item" href="rental-agreements.html">
              My Rental Agreements
            </a>
          </li>
          <li>
            <a class="dropdown-item" href="vendor-menu.html">
              Public Menu
            </a>
          </li>
          <li><hr class="dropdown-divider" /></li>
          <li>
            <a class="dropdown-item text-danger" href="#" id="logoutBtn">
              Logout
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- CONTENT -->
  <div class="container mt-5">
    <h1 class="text-danger mb-4">Vendor Rental Dashboard</h1>

    <!-- STATS -->
    <div class="row mb-4">
      <div class="col-md-4 mb-3">
        <div class="card text-center p-3">
          <h2 id="totalAgreements" class="text-danger">0</h2>
          <p class="mb-0">Total Rental Agreements</p>
        </div>
      </div>

      <div class="col-md-4 mb-3">
        <div class="card text-center p-3">
          <h2 id="totalMonthlyRent" class="text-danger">$0</h2>
          <p class="mb-0">Total Monthly Rent Due</p>
        </div>
      </div>

      <div class="col-md-4 mb-3">
        <div class="card text-center p-3">
          <h2 id="rentDueCount" class="text-danger">0</h2>
          <p class="mb-0">Payments Pending</p>
        </div>
      </div>
    </div>

    <!-- QUICK ACTIONS (RESTORED) -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Quick Actions</h5>
        <div class="d-flex flex-wrap gap-2">
          <a href="rental-agreements.html" class="btn btn-danger">
            <i class="bi bi-file-text me-2"></i>My Rental Agreements
          </a>
          <a href="create-rental-agreement.html" class="btn btn-outline-danger">
            <i class="bi bi-plus-lg me-2"></i>Create Agreement
          </a>
          <a href="menu-management.html" class="btn btn-outline-danger">
            <i class="bi bi-menu-button me-2"></i>Manage Menu
          </a>
          <a href="vendor-menu.html" class="btn btn-outline-danger">
            <i class="bi bi-eye me-2"></i>Public Menu
          </a>
          <a href="feedback.html" class="btn btn-outline-danger">
            <i class="bi bi-chat me-2"></i>Feedback
          </a>
        </div>
      </div>
    </div>

    <!-- UPCOMING PAYMENTS (REPLACED RECENT ORDERS) -->
    <div class="card">
      <div class="card-header bg-danger text-white">
        <h5 class="mb-0">Upcoming Rental Payments</h5>
      </div>
      <div class="card-body">
        <table class="table">
          <thead>
            <tr>
              <th>Stall</th>
              <th>Due Date</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="paymentsTable">
            <tr>
              <td colspan="5" class="text-center">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="bg-dark text-white py-4 mt-5">
    <div class="container text-center">
      <p>&copy; 2024 HawkerHub. All rights reserved.</p>
    </div>
  </footer>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- FIREBASE + LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      updateDoc,
      doc,
      orderBy
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBazksxHfRgOJcraIVqslvCWqZT4qjTWZE",
      authDomain: "hawkerhub-b4a7a.firebaseapp.com",
      projectId: "hawkerhub-b4a7a",
      storageBucket: "hawkerhub-b4a7a.appspot.com",
      messagingSenderId: "43569063246",
      appId: "1:43569063246:web:9d18d5107d2081784e2a1f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const user = JSON.parse(localStorage.getItem("hawkerhub_user"));
    if (!user || user.role !== "vendor") {
      window.location.href = "login.html";
    }

    document.getElementById("logoutBtn").onclick = () => {
      localStorage.removeItem("hawkerhub_user");
      window.location.href = "index.html";
    };

    const vendorId = user.vendorId;

    const paymentsTable = document.getElementById("paymentsTable");

    async function loadDashboard() {
      // AGREEMENTS
      const agreementsSnap = await getDocs(
        query(collection(db, "rentalAgreements"), where("vendorId", "==", vendorId))
      );

      document.getElementById("totalAgreements").innerText = agreementsSnap.size;

      // PAYMENTS
      const paymentsSnap = await getDocs(
        query(
          collection(db, "payments"),
          where("vendorId", "==", vendorId),
          orderBy("dueDate")
        )
      );

      let totalDue = 0;
      let pendingCount = 0;
      paymentsTable.innerHTML = "";

      paymentsSnap.forEach(p => {
        const data = p.data();

        if (data.status === "pending") {
          totalDue += data.amount;
          pendingCount++;

          paymentsTable.innerHTML += `
            <tr>
              <td>${data.stallName}</td>
              <td>${data.dueDate}</td>
              <td>$${data.amount.toFixed(2)}</td>
              <td>
                <span class="badge bg-warning text-dark">Pending</span>
              </td>
              <td>
                <button class="btn btn-sm btn-danger"
                  onclick="payRent('${p.id}')">
                  Pay
                </button>
              </td>
            </tr>
          `;
        }
      });

      if (!paymentsTable.innerHTML) {
        paymentsTable.innerHTML =
          `<tr><td colspan="5" class="text-center">No pending payments ðŸŽ‰</td></tr>`;
      }

      document.getElementById("totalMonthlyRent").innerText =
        "$" + totalDue.toFixed(2);
      document.getElementById("rentDueCount").innerText = pendingCount;
    }

    window.payRent = async (paymentId) => {
      if (!confirm("Confirm payment?")) return;

      await updateDoc(doc(db, "payments", paymentId), {
        status: "paid",
        paymentDate: new Date().toISOString().slice(0, 10)
      });

      loadDashboard();
    };

    loadDashboard();
  </script>
</body>
</html>
